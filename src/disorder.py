# Dependencies
import numpy as np
import subprocess
import tempfile
import os

class MobiDBLite(object):

    # Constructor
    def __init__(self, cmd=['mobidb_lite.py'], env=os.environ.copy()):
        # Save attributes
        self.cmd = cmd  # Path to MobiDB Lite executable
        self.env = env  # Environmental variables

    # Run method
    def run(self, sequences, acc_regex='^>(\S+)', ret_comp_bias=False, verbose=True):
        """Run MobiDB Lite disorder predictor
        Takes as input a list of sequences and returns a lis of boolean (1/0)
        values, where an item has value 1 if the residue in the same position is
        predicted to be disordered, 0 otherwise.

        Args
        sequences (list)    List of strings containing fasta entries
        verbose (bool)      Wether to show verbose log or not

        Return
        (list(list))        List of boolean (1/0) lists
        """
        # Define temporary input file
        fasta_file = tempfile.NamedTemporaryFile(delete=False)
        # Define temporary output file
        out_file = tempfile.NamedTemporaryFile(delete=False)

        # Make input fasta file
        with open(fasta_file.name, 'w') as ff:
            # Loop through each input sequence
            for seq in sequences:
                # Write out fasta entry
                ff.write(seq + '\n')

        # Run MobiDB Lite command
        cmd_out = subprocess.run(
            capture_output=True,  # Capture console output
            encoding='utf-8',  # stdout/stderr encoding
            env=self.env,  # Environmental variables
            # Executable arguments
            args=[
                *self.cmd,
                '-o', out_file.name,  # Path to output file
                fasta_file.name  # Path to input fasta file
            ]
        )

        # Debug
        print(cmd_out)

        with open(out_file.name, 'r') as of:
            # Debug
            print(of.read())

        # Delete temporary files
        os.remove(fasta_file.name)
        os.remove(out_file.name)

    @staticmethod
    def compute_comp_bias(sequences, threshold=1):
        raise NotImplementedError

# Unit test
if __name__ == '__main__':

    # Get environmental variables
    env = {**os.environ.copy(), **{
        'PATH': ':'.join([
            "/nfs/production/metagenomics/mgnifams/dclementel/Pfam/PfamScripts/make",
            "/nfs/production/xfam/pfam/software/bin",
            "/nfs/production/metagenomics/mgnifams/dclementel/Pfam/PfamScripts/mgnifam",
            "/usr/lib64/qt-3.3/bin",
            "/ebi/lsf/ebi/ppm/10.2/bin",
            "/ebi/lsf/ebi/ppm/10.2/linux2.6-glibc2.3-x86_64/bin",
            "/ebi/lsf/ebi/10.1/linux3.10-glibc2.17-x86_64/etc",
            "/ebi/lsf/ebi/10.1/linux3.10-glibc2.17-x86_64/bin",
            "/usr/lpp/mmfs/bin",
            "/usr/local/bin",
            "/usr/bin",
            "/usr/local/sbin",
            "/usr/sbin",
            "/bin",
            "/usr/bin",
            "/homes/dclementel/bin"
        ]),
        'PYTHONPATH': ':'.join([
            '/ebi/sp/pro1/interpro/python-modules/lib64/python',
            '/ebi/sp/pro1/interpro/python-modules/lib/python'
        ])
    }}

    # We know that cluster MGYP001051398202 has been identified as biased
    # cluster, so we use its members to test MobiDB Lite python wrapper

    # Define list of test fasta entries
    sequences = {
        "MGYP000851679260": ">MGYP000851679260 PL=10 UP=0 BIOMES=1000000000000 LEN=23 CR=0\nMYEIKKLLTLILIAALTMTPLPV",
        "MGYP001032022277": ">MGYP001032022277 PL=10 UP=0 BIOMES=0000000000001 LEN=109 CR=0\nGITNEEFVTTNESRDGGPAFDYTDCVMEQAYLVTDRYEYTGIPKNENDSFPGAWNVEFPNAANRQYLRLVYFDDTIDVSKYEGEEIKFSAKAFRSSSSLFDYYDAIIIE",
        "MGYP001036154158": ">MGYP001036154158 PL=10 UP=0 BIOMES=0000000000001 LEN=224 CR=0\nLVACGGGSGAGDNNTPSTGNGDTTSTDTPSMTKEEMLETAEDGNISELNHLIAENILSAKQAYCGKVLTFRGNIYGIKEDYITFNHGKGSIIVYLPAEDIVNLKTDQWVTIIGLTNDEFITTKESRGGEPTSDYIDCIMEQAYLVTDRYEYTGIPKNENNSHPGAWDVEFPDSNNPAYLRLVYFDDSIDVSQYVGKEITFSAKAIGGDYFESAFVDYIDAIIIE",
        "MGYP001038205783": ">MGYP001038205783 PL=00 UP=0 BIOMES=0000000000001 LEN=237 CR=1\nMKKLLALILAAALALSLVACGGDSGAGDTNTPSGGNGDTTSTDTPSMTKEEILETAEDGDIYELNHLISENILNAKQSYCGKNLILKSTVDEIKEDCIVFNHGMGSVIVYLPSEDIVNLKTNQTITIVGITNEEFVTTNESRDGGPAFDYTDCVMEQAYLVTDRYEYTGIPKNENDSFPGAWNVEFPNAANRQYLRLVYFDDTIDVSKYEGEEIKFSAKAFRSSSSLFDYYDAIIIE",
        "MGYP000111223802": ">MGYP000111223802 PL=00 UP=0 BIOMES=0000000000001 LEN=235 CR=1\nMKKTLALILTAALTLSLAACGGSNGTENNNTSSTGNTTSSGGVEDSTPSMTKEEMLEVAVNGDISELNSLIADNILSAKQAYCGKVLTMKHAVDEIKEDCIIFNHGMGSVIVYLPEEDIINLKAKQYITIVGITSEDFITTKESRYGPIAEDYTDCIMEQAYLVADRYEYSGTPKSKNSDFDGAWNVEFSNVSNPQYLRLVYFDDSVDVGQYEGKEITFSAKVIDGKYYDVVITG",
        "MGYP001043698415": ">MGYP001043698415 PL=10 UP=0 BIOMES=0000000000001 LEN=115 CR=0\nMKKTLALILIAALTLSLAACGGSNGKENNNTSSTGNTTSSGGVEDSTPSMTKEEMLEVAVNGDISELNSLIADNILSAKQAYCGKVLTMKHAVDEIKEDCIIFNHKTLSFIINHA",
        "MGYP001044920212": ">MGYP001044920212 PL=11 UP=0 BIOMES=0000000000001 LEN=232 CR=0\nKLLALMLAAALALSLVACGGGSGAGDNNTPSTGNGDTSSTDTPSMTKEEMLETAEDGNISELNHLIAENILSAKQAYCGKVLTFRGNIYGIKEDCIIFNHGKGSIIVYLPAEDIVNLKTDQWVTIIGLTNDEFITTKESRGGEPTSDYIDCIMEQAYLVTDRYEYTGIPENENNSYPGAWNVEFPDSNNPEYRRLVYFDDSIDVSQYVGKEITFSAKAIGGDYFESAFVDYI",
        "MGYP001045957942": ">MGYP001045957942 PL=01 UP=0 BIOMES=0000000000001 LEN=126 CR=0\nVIVYLPEEDIINLKAKQYITIVGITSEDFITTKESRYGPIAEDYTDCIMEQAYLVADRYEYSGTPKSKNSDFDGAWNVEFSNVSNPQYLRLVYFDDSVDVGQYEGKEITFSAKVIDGKYYDVVITG",
        "MGYP001051398202": ">MGYP001051398202 PL=00 UP=0 BIOMES=0000000000001 LEN=240 CR=1\nMKKLLALMLAAALALSLVACGGGGAEDNNTTPSTGNGDTTGTDTPSMTKEEMLETAEDGNISELNHLIAENILSAKQAYCGKVLTFRGNIYGIKEDCITFNHGKGSIIVYLPAEDIVNLKTDQWVTIIGLTNDEFITTKESRGGEPASDYTDCIMEQAYLVTDRYEYTGIPKNENNSHPGAWDVEFPDSDNPEYLRLVYFDDSIDVSQYVGKEITFSAKVMDGDYFESAFVDYIDAIIIE",
        "MGYP001051968473": ">MGYP001051968473 PL=01 UP=0 BIOMES=0000000000001 LEN=52 CR=0\nMKKTLALILIAALTLSLAACGGSNGKENNNTSSTGNTTASGGVEDSTPSMTK",
        "MGYP001058115450": ">MGYP001058115450 PL=11 UP=0 BIOMES=0000000000001 LEN=176 CR=0\nDTNTPSGGNGDTTSTDTPSMTKEEILETAEDGDIYELNHLISENILNAKQSYCGKNLILKSTVDEIKEDCIVFNHGMGSVIVYLPSQDIVNLKTNQTITIVGITNEEFVTTNESRDGGPAFDYTDCVMEQAYLVTDRYEYTGIPKNKNDSFPGAWNVEFPNAANRQYLRLVYFDDT",
        "MGYP001061453680": ">MGYP001061453680 PL=01 UP=0 BIOMES=0000000000001 LEN=219 CR=0\nACGGDSGAGDTNTPSGGNGDTTSTDTPSMTKEEILETAEDGDIYELNHLISENILNAKQSYCGKNLILKSTVDEIKEDCIVFNHGMGSVIVYLPSEDIVNLKTNQTITIVGITNEEFVTTNESRDGGPAFDYTDCVMEQAYLVTDRYEYTGIPKNENDSFPGAWNVEFPNAANRQYLRLVYFDDTIDVSKYEGEEIKFSAKAFRSSSSLFDYYDAIIIE",
        "MGYP001064539059": ">MGYP001064539059 PL=10 UP=0 BIOMES=0000000000001 LEN=202 CR=0\nMKKLLALMLAAALALSLVACGGGNGAGDTNTSSTGNGDTTSTDTPSMTKEEMLETAEDGNISELNHLIAENILSAKQAYCGKVLTFRGNIYGIKEDCIIFNHGKGSIIVYLPAEDIVNLKTDQWVTIIGLTNDEFITTKESRGGEPTSDYIDCIMEQAYLVTDRYEYTGIPENENNSYPGAWNVEFPDSNNPEYRRLVYFDD",
        "MGYP001065068340": ">MGYP001065068340 PL=00 UP=0 BIOMES=0000000000001 LEN=235 CR=0\nMKKTLALILTAALVLSLAACGGSNGKENNNTSSTGNTTSSGGVEDSTPSMTKEEMLEVAVNGDISELNSLIADNILSAKQAYCGKVLTMKHAVDEIKEDCIIFNHGMGSVIVYLPEEDIINLKAKQYITIVGITSEDFITTKESRYGPIAEDYTDCIMEQAYLVADRYEYSGTPKSKNSDFDGAWNVEFSNVSNPQYLRLVYFDDSVDAGQYEGKEITFSAKVIDGKYYDVVITG",
        "MGYP001067122102": ">MGYP001067122102 PL=01 UP=0 BIOMES=0000000000001 LEN=219 CR=0\nLAACGGSNGKENNNTSSTGNTTSSGGVEDSTPSMTKEEMLEVAVNGDISELNSLIADNILSAKQAYCGKVLTMKHAVDEIKEDCIIFNHGMGSVIVYLPEEDIINLKAKQYITIVGITSEDFITTKESRYGPIAEDYTDCIMEQAYLVADRYEYSGTPKSKNSDFDGAWNVEFSNVSNPQYLRLVYFDDSIDVGQYEGKEITFSAKVIDGKYYDVVITG",
        "MGYP001067638354": ">MGYP001067638354 PL=00 UP=0 BIOMES=0000000000001 LEN=235 CR=0\nMKKTLALILIAALTLSLAACGGSNGKENNNTSSTGNTTSSGGVEDSTPSMTKEEMLEVAVNGDISELNSLIADNILSAKQAYCGKVLTMKHAVDEIKEDCIIFNHGMGSVIVYLPEEDIINLKAKQYITIVGITSEDFITTKESRYGPMAEDYTDCIMEQAYLVADRYEYSGTPKSKNSDFDGAWNVEFSNVSNPQYLRLVYFDDSVDVGQYEGKEITFSAKVIDGKYYDVVITG",
        "MGYP001069194978": ">MGYP001069194978 PL=10 UP=0 BIOMES=0000000000001 LEN=224 CR=0\nALSLVACGGDSGAGDTNTPSGGNGDTTSTDTPSMTKEEILETAEDGDIYELNHLISENILNAKQSYCGKNLILKSTVDEIKEDCIVFNHGMGSVIVYLPSEDIVNLKTNQTITIVGITNEEFVTTNESRDGGPAFDYTDCVMEQAYLVTDRYEYTGIPKNENDSFPGAWNVEFPNAANRQYLRLVYFDDTIDVSKYEGEEIKFSAKAFRSSSSLFDYYDAIIIE",
        "MGYP001071076496": ">MGYP001071076496 PL=10 UP=0 BIOMES=0000000000001 LEN=55 CR=1\nMKKLLALILAAALALSLVACGGGGGVGDNNTPSTGNGDTTGTDTPSGGEDSTQTA",
        "MGYP001075906476": ">MGYP001075906476 PL=00 UP=0 BIOMES=0000000000001 LEN=240 CR=1\nMKKLLALMLAAALALSLVACGGGSGAGDNNTPSTGNGDTSSTDTPSMTKEEMLETAEDGNISELNHLIAENILSAKQAYCGKVLTFRGNIYGIKEDCIIFNHGKGSIIVYLPAEDIVNLKTDQWVTIIGLTNDEFITTKESRGGEPTSDYIDCIMEQAYLVTDRYEYTGIPENENNSYPGAWNVEFPDSNNPEYRRLVYFDDSIDVSQYVGKEITFSAKAIGGDYFESAFVDYIDAIIIE",
        "MGYP001075906285": ">MGYP001075906285 PL=11 UP=0 BIOMES=0000000000001 LEN=176 CR=1\nSTDTPSMTKEEMLETAEDGNISELNHLIAENILSAKQAYCGKVLTFRGNIYGIKEDCIIFNHGKGSIIVYLPAEDIVNLTDQWVTIIGLTNDEFITTKESRGGEPTSDYIDCIMEQAYLVTDRYEYTGIPENENNSYPGAWNVEFPDSNYRRLVYFDDSIDVSQYVGKEITFSAKA",
        "MGYP001081128765": ">MGYP001081128765 PL=00 UP=0 BIOMES=0000000000001 LEN=235 CR=0\nMKKTLALILIAALTLSLAACGGSNGKENNNTSSTGNTTSSGGVEDSTPSMTKEEMLEVAVNGDISELNSLIADNILSAKQAYCGKVLTMKHAVDEIKEDCIIFNHGMGSVIVYLPEEDIINLKAKQYITIVGITSEDFITTKESRYGPIAEDYTDCIMEQAYLVADRYEYSGTPKSKNSDFDGAWNVEFSNVSNPQYLRLVYFDDSVDAGQYEGKEITFSAKVIDGKYYDVVITG",
        "MGYP001084165602": ">MGYP001084165602 PL=10 UP=0 BIOMES=0000000000001 LEN=62 CR=1\nMKKLLALILAAALALSLVACGGDSGAGDTNTPSGGNGDTTSTDTPSIPSGQYLNYSRIESGQ",
        "MGYP001086225311": ">MGYP001086225311 PL=10 UP=0 BIOMES=0000000000001 LEN=74 CR=0\nMKKLLALMLAAALALSLVACGGGSGAGDNNTPSTGNGDTSSTDTPSMTKEEMLETAEDGNISELNHLIAENILS",
        "MGYP000355976475": ">MGYP000355976475 PL=00 UP=0 BIOMES=0000000000001 LEN=235 CR=0\nMKKTLALILIAALTLSLAACGGSNGKENNNTSSTGNTTSSGGVEDSTPSMTKEEMLEVAVNGDISELNSLIADNILSAKQAYCGKVLTMKHAVDEIKEDCIIFNHGMGSVIVYLPEEDIINLKAKQYITIVGITSEDFITTKESRYGPMAEDYTDCIMEQAYLVADRYEYSGTPKSKNSDFDGAWNVEFSNVSNPQYLRLVYFDDSVDAGQYEGKEITFSAKVIDGKYYDVVITG",
        "MGYP001108197041": ">MGYP001108197041 PL=00 UP=0 BIOMES=0000000000001 LEN=237 CR=0\nMKKLLALILAAALALSLVACGGGSGAGDTNTPSGGNGDTTSTDTPSMTKEEILETAEDGDIYELNHLISENILNAKQSYCGKNLILKSTVDEIKEDCIVFNHGMGSVILYLPSQDIVNLKTNQTITIVGITNEEFVTTNESRDGGPAFDYTDCVMEQAYLVTDRYEYTGIPKNKNDSFPGAWNVEFPNAANRQYLRLVYFDDTIDVSKYEGEEIKFSAKAFRSSSSLFDYYDAIIIE",
        "MGYP001113077337": ">MGYP001113077337 PL=00 UP=0 BIOMES=0000000000001 LEN=235 CR=0\nMKKTLALILTAALTLSLAACGGSNGKENNNTSSTGNTTSSGGVEDSTPSMTKEEMLEVAVNGDISELNSLIADNILSAKQAYCGKVLTMKHAVDEIKEDCIIFNHGMGSVIVYLPEEDIINLKAKQYITIVGITSEDFITTKESRYGPMAEDYTDCIMEQAYLVADRYEYSGTPKSKNSDFDGAWNVEFSNVSNPQYLRLVYFDDSVDAGQYEGKEITFSAKVIDGKYYDVVITG",
        "MGYP001114448909": ">MGYP001114448909 PL=00 UP=0 BIOMES=0000000000001 LEN=235 CR=0\nMKKTLALILTAALTLSLAACGGSNGTENNNTSSTGNTTSSGGVEDSTPSMTKEEMLEVAVNGDISELNSLIADNILSAKQAYCGKVLTMKHAVDEIKEDCIIFNHGMGSVIVYLPEEDIINLKAKQYITIVGITSEDFITTKESRYGPIAEDYTDCIMEQAYLIADRYEYSGTPKSKNSDFDGAWNVEFSNVSNPQYLRLVYFDDSVDVGQYEGKEITFSAKVIDGKYYDVVITG",
        "MGYP001125457394": ">MGYP001125457394 PL=00 UP=0 BIOMES=0000000000001 LEN=237 CR=0\nMKKLLALMLAAALALSLVACGGGNGAGDTNTSSTGNGDTTSTDTPSMTKEEMLETAEDGNISELNHLIAENILSAKQAYCGKVLTFRGNIYGIKEDCIIFNHGKGSIIVYLPAEDIVNLKTDQWVTIIGLTNDEFITTKESRGGEPTSDYIDCIMEQAYLVTDRYEYTGIPENENNSYPGAWNVEFPDSNYRRLVYFDDSIDVSQYVGKEITFSAKAIGGDYFESAFVDYIDAIIIE",
        "MGYP001130951151": ">MGYP001130951151 PL=01 UP=0 BIOMES=0000000000001 LEN=141 CR=0\nMKKTLALILIAALTLSLAACGGSNGKENNNTSSTGNTTSSGGVEDSTPSMTKEEMLEVAVNGDISELNSLIADNILSAKQAYCGKVLTMKHAVDEIKEDCIIFNHGMGSVIVYLPEEDIINLKAKQYITIVGITSEDFITT",
        "MGYP001143804030": ">MGYP001143804030 PL=01 UP=0 BIOMES=0000000000001 LEN=48 CR=0\nMKKTLALILIAALTLSLAACGGSNGKENNNTSSTGNTTSSGGVEDSTP"
    }
    # Debug
    print('There are {:d} input sequences'.format(len(sequences)))

    # Make new instance of MobiDB Lite
    mdb_lite = MobiDBLite(env=env)
    # Run MobiDB Lite predictor
    mdb_lite.run(sequences.values())
